name: Vibe Research

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      topic:
        description: 'Research topic'
        required: true
        type: string
      depth:
        description: 'Research depth'
        required: false
        default: 'Standard Research'
        type: choice
        options:
          - Quick Overview
          - Standard Research
          - Deep Dive

jobs:
  research:
    runs-on: ubuntu-latest
    # Only run if triggered manually OR if the issue has the 'research' label
    if: github.event_name == 'workflow_dispatch' || contains(github.event.issue.labels.*.name, 'research')
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore VibeResearch.CLI/VibeResearch.CLI.csproj

      - name: Build
        run: dotnet build VibeResearch.CLI/VibeResearch.CLI.csproj --configuration Release --no-restore

      - name: Create output directories
        run: |
          mkdir -p docs/_researches
          mkdir -p html
          mkdir -p research-output

      - name: Set research parameters from issue
        if: github.event_name == 'issues'
        run: |
          # Extract topic from issue title (remove [Research] prefix if present)
          TOPIC="${{ github.event.issue.title }}"
          TOPIC="${TOPIC#\[Research\] }"
          echo "VIBE_TOPIC=$TOPIC" >> $GITHUB_ENV
          
          # Extract depth from issue body
          BODY="${{ github.event.issue.body }}"
          
          # Try to extract from the form field "Research Depth"
          if echo "$BODY" | grep -q "Deep Dive"; then
            echo "VIBE_DEPTH=Deep Dive" >> $GITHUB_ENV
          elif echo "$BODY" | grep -q "Quick Overview"; then
            echo "VIBE_DEPTH=Quick Overview" >> $GITHUB_ENV
          elif echo "$BODY" | grep -q "Standard Research"; then
            echo "VIBE_DEPTH=Standard Research" >> $GITHUB_ENV
          else
            # Default to Standard Research
            echo "VIBE_DEPTH=Standard Research" >> $GITHUB_ENV
          fi
          
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV
          
          # Log for debugging
          echo "Research Topic: $TOPIC"
          echo "Research Depth: $(echo $BODY | grep -o -E '(Quick Overview|Standard Research|Deep Dive)' | head -1 || echo 'Standard Research')"

      - name: Set research parameters from workflow dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "VIBE_TOPIC=${{ inputs.topic }}" >> $GITHUB_ENV
          echo "VIBE_DEPTH=${{ inputs.depth }}" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=manual" >> $GITHUB_ENV

      - name: Add processing comment to issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const topic = process.env.VIBE_TOPIC || '${{ github.event.issue.title }}';
            const depth = process.env.VIBE_DEPTH || 'Standard Research';
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `🔬 **Vibe Research** is processing your request...\n\n- **Topic:** ${topic}\n- **Depth:** ${depth}\n\nThis may take a few minutes. Results will be committed to the repository and published to GitHub Pages when complete.`
            })

      - name: Run Vibe Research
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          VIBE_OUTPUT_DIR: ${{ github.workspace }}/research-output
        run: dotnet run --project VibeResearch.CLI/VibeResearch.CLI.csproj --configuration Release --no-build

      - name: Move output files to correct folders
        run: |
          # Move markdown files to docs/_researches/ (Jekyll collection)
          find research-output -name "*.md" -exec mv {} docs/_researches/ \;
          # Move HTML files to html/
          find research-output -name "*.html" -exec mv {} html/ \;
          # List the results
          echo "=== Markdown files (docs/_researches/) ==="
          ls -la docs/_researches/
          echo "=== HTML files (html/) ==="
          ls -la html/

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/ html/
          git commit -m "📚 Research: ${{ env.VIBE_TOPIC }} (#${{ env.ISSUE_NUMBER }})" || echo "No changes to commit"
          git push

      - name: Get generated file names
        id: files
        run: |
          MD_FILE=$(ls -1t docs/_researches/*.md 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "")
          HTML_FILE=$(ls -1t html/*.html 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "")
          # Extract slug for GitHub Pages URL (remove date prefix and .md extension)
          SLUG=$(echo "$MD_FILE" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//' | sed 's/\.md$//')
          echo "md_file=$MD_FILE" >> $GITHUB_OUTPUT
          echo "html_file=$HTML_FILE" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT

      - name: Comment results on issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const mdFile = '${{ steps.files.outputs.md_file }}';
            const htmlFile = '${{ steps.files.outputs.html_file }}';
            const slug = '${{ steps.files.outputs.slug }}';
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const pagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}`;
            
            let body = '✅ **Research Complete!**\n\n';
            
            // GitHub Pages link (primary)
            if (slug) {
              body += `### 🌐 View Research\n\n`;
              body += `**[📖 Read on GitHub Pages](${pagesUrl}/research/${slug}/)**\n\n`;
            }
            
            body += '### 📄 Source Files\n\n';
            
            if (mdFile) {
              body += `- **Markdown:** [docs/_researches/${mdFile}](${repoUrl}/blob/main/docs/_researches/${mdFile})\n`;
            }
            if (htmlFile) {
              body += `- **HTML:** [html/${htmlFile}](${repoUrl}/blob/main/html/${htmlFile})\n`;
            }
            
            body += '\n---\n';
            body += `🔬 _Generated by [Vibe Research](${pagesUrl})_`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Close issue with completion label
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            // Add 'completed' label
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['research-complete']
            });
            
            // Close the issue
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Upload research artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vibe-research-${{ github.run_number }}
          path: |
            docs/**
            html/**
          retention-days: 30


